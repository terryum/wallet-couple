# Product Requirement Document (PRD): Wallet UX - 사용자 인터랙션

## 1. 개요 (Overview)
* **문서명:** PRD_wallet_ux.md
* **목적:** 사용자 관점의 UI 인터랙션, 클릭 동작, 모달 우선순위, 네비게이션 흐름 정의
* **관련 문서:** [`PRD_wallet.md`](./PRD_wallet.md) (상위), [`Current_Status.md`](./Current_Status.md)

---

## 2. 화면 구성 (Screen Structure)

### 2.1. 메인 화면 (내역 화면) - `/`
- **기본 뷰:** 월별 거래 내역 리스트
- **헤더:** 월 선택, 소유자 필터, 설정 메뉴
- **요약 카드:** 이번 달 총 소득/지출 (드롭다운으로 세부 항목)
- **거래 리스트:** 날짜별 그룹핑, 스와이프 삭제 지원

### 2.2. 대시보드 화면 - `/dashboard`
- **도넛 차트:** 카테고리별 지출 비중 (지출만 분석, 소득 제외)
- **스택 바 차트:** 월별 지출 추세 (최근 6개월, 지출만 분석)
- **청구금액 비교:** 월별 카드사별 이용금액 (지출만 집계)
- **기간 선택:** 직접 기간 선택 팝업

> **Note:** 대시보드의 모든 차트는 **지출(expense) 데이터만** 분석합니다. 소득 데이터는 메인 화면의 SummaryCard에서 별도로 표시됩니다.

---

## 3. 인터랙션 흐름 (Interaction Flows)

### 3.1. 파일 업로드 흐름
```
[+] 버튼 클릭
    ↓
파일 선택 다이얼로그
    ↓
(암호화 파일인 경우)
    → 비밀번호 입력 다이얼로그
    → 틀림: 재입력 또는 건너뛰기
    → 맞음: 다음 파일로 진행
    ↓
스트리밍 업로드 (진행 상황 표시)
    ↓
AI 분류 진행 ("AI 분류 중 (3/59)")
    ↓
업로드 완료
    ↓
UploadResultPopup 표시
    → (2단계 소스의 경우) 지출 → 소득 순서
```

### 3.2. 업로드 결과 팝업 흐름
```
UploadResultPopup (지출 내역)
    ↓
[항목 클릭] (어디를 클릭해도 동일)
    → EditModal 열기
    → 편집/삭제 후 저장
    → (이용처/카테고리 변경 시)
        → SimilarTransactionsModal (50ms 딜레이)
        → 유사 거래 일괄 수정
    → EditModal 닫힘
    → UploadResultPopup으로 복귀 ← (중요: 홈으로 가지 않음!)
    → 데이터 자동 새로고침 (삭제/수정 반영)
    ↓
[스와이프/롱프레스 삭제]
    → Optimistic Update (즉시 UI 반영)
    → API 호출 (백그라운드)
    ↓
[다음 버튼] (2단계 소스인 경우)
    → 소득 내역으로 전환
    ↓
[확인 버튼]
    → UploadResultPopup 닫힘
    → 홈 화면으로 복귀
```

### 3.3. 거래 편집 흐름 (일반)
```
TransactionRow 클릭 (어디를 클릭해도 동일)
    ↓
EditModal 열기
    ↓
[수정 완료] / [삭제하기]
    ↓
(이용처/카테고리 변경 시)
    → SimilarTransactionsModal (50ms 딜레이)
    → 유사 거래 일괄 수정 선택
    ↓
EditModal 닫힘
```

> **Note:** CategorySheet는 Phase 16에서 제거됨. 모든 클릭은 EditModal로 직접 이동.

---

## 4. 모달 우선순위 (Modal Priority)

### 4.1. 모달 스택 구조
```
Level 0: 메인 화면
Level 1: UploadResultPopup / EditModal (from list)
Level 2: EditModal (from popup)
Level 3: SimilarTransactionsModal
```

### 4.2. 뒤로가기 버튼 동작
각 모달은 `useModalBackHandler` 훅으로 브라우저 뒤로가기 버튼을 처리:

| 상태 | 뒤로가기 동작 |
|-----|-------------|
| SimilarTransactionsModal 열림 | SimilarTransactionsModal 닫기 |
| EditModal 열림 | EditModal 닫기 |
| UploadResultPopup만 열림 | UploadResultPopup 닫기 |
| 부모 모달 + 자식 모달 | 자식 모달만 닫기 (부모 유지) |

### 4.3. 중첩 모달 처리
- **부모 모달:** `disabled: true` 옵션으로 뒤로가기 핸들러 비활성화
- **자식 모달:** 정상적으로 뒤로가기 처리
- **자식 닫힘 시:** 부모 모달 핸들러 재활성화

---

## 5. 제스처 및 터치 인터랙션

### 5.1. 스와이프 삭제 (SwipeableRow)
- **트리거:** 왼쪽으로 스와이프
- **임계값:** 80px 이상 스와이프
- **동작:** 삭제 확인 없이 바로 삭제
- **롱프레스:** 1초 이상 누르면 삭제 모드 진입

### 5.2. 차트 인터랙션 (PieChartCard)
| 클릭 위치 | 동작 |
|----------|-----|
| 파이 슬라이스 | 해당 카테고리 상세 팝업 |
| 도넛 여백 | 하이라이트 리셋 |
| 중앙 (총 지출) | 전체 내역 팝업 |

### 5.3. 차트 인터랙션 (StackedBarCard)
| 클릭 위치 | 동작 |
|----------|-----|
| 막대 세그먼트 | 해당 월/카테고리 상세 팝업 |
| 레전드 항목 | 해당 카테고리 하이라이트 + 동기화 |

---

## 6. 카테고리 표시 규칙

### 6.1. 지출 vs 소득 분리
- **EditModal:** `transaction_type`에 따라 카테고리 목록 분리
  - `expense`: 지출 카테고리 (Set A + Set B)
  - `income`: 소득 카테고리

### 6.2. 카테고리 뱃지 색상
- 각 카테고리별 고정 색상 (`CATEGORY_COLORS`)
- 소득 카테고리: 녹색 계열
- 지출 카테고리: 다양한 색상

---

## 7. 요약 카드 (SummaryCard)

### 7.1. 드롭다운 구조
```
이번 달 총 소득: 8,276,000원 (+123만)
└─ 급여/상여:   8,076,000원 (+100만)
└─ 강연/도서:     150,000원 (+20만)
└─ etc.:           50,000원 (+3만)

이번 달 총 지출: 3,500,000원 (-50만)
└─ 일반소비:   1,500,000원 (-30만)
└─ 부모/육아:  1,200,000원 (+0)
└─ 고정비:       800,000원 (-20만)
```

### 7.2. 증감 색상 규칙
- **소득:** 증가=파랑(+), 감소=빨강(-)
- **지출:** 증가=빨강(+), 감소=파랑(-) (반대!)

---

## 8. 데이터 로더 UX

### 8.1. 우리은행 2단계 팝업
우리은행, 한국투자증권 등 소득+지출이 함께 있는 소스:
1. **1단계:** 지출 내역 표시 → [다음 (소득 내역)] 버튼
2. **2단계:** 소득 내역 표시 → [확인] 버튼

### 8.2. CD 거래 자동 변환
- **적요:** "CD출금", "CD입금" 등
- **이용처:** "ATM 인출"로 자동 표시

### 8.3. 자동 제외 항목
- 5,000원 이하 소액 거래
- 본인/배우자 계좌 이체
- 카드 결제 (다른 카드 로더에서 처리)
- 상품권 충전 (다른 상품권 로더에서 처리)

---

## 9. 에러 및 예외 처리

### 9.1. 업로드 에러
| 에러 | 사용자 메시지 |
|-----|-------------|
| 파싱 실패 | "지원하지 않는 파일 형식입니다" |
| 검증 실패 | "파일 합계와 로딩 합계가 다릅니다" |
| 비밀번호 오류 | "비밀번호가 맞지 않습니다. 다시 입력해주세요" |

### 9.2. 네트워크 에러
- 자동 재시도 없음
- "네트워크 오류가 발생했습니다" 메시지

---

*마지막 업데이트: 2025-12-31 - 대시보드 소득/지출 분리 (차트에서 지출만 분석)*
