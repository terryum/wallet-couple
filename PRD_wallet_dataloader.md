# Product Requirement Document (PRD): Wallet Data Loader

## 1. 개요 (Overview)
* **문서명:** PRD_wallet_dataloader.md
* **목적:** 다양한 금융사(카드, 은행)의 이질적인 명세서(Excel/PDF)를 표준화된 데이터 포맷으로 파싱하고 검증하는 로직 정의.
* **범위:** 현대카드, 롯데카드, 삼성카드, KB국민카드, 온누리상품권, 성남사랑상품권 (우리은행은 추후 구현)
* **최종 업데이트:** 2025-12-30

## 2. 데이터 로딩 아키텍처 (Architecture)

### 2.1. 파서 선택 전략 (Parser Selection Strategy)
업로드된 파일에 대해 다음 우선순위로 적절한 파서(Loader)를 선택한다.

1.  **헤더 분석 (Content Inspection):** 파일의 헤더 행을 읽어 특정 컬럼명이 존재하는지 확인하여 카드사 식별.
    * 모든 시트를 검사하여 헤더를 찾음
2.  **파일명 매칭:** 파일명에 '현대', '롯데', '삼성', 'KB' 등의 키워드가 포함되어 있는지 확인.
3.  **Fallback:** 위 조건에 해당하지 않을 경우 `GeneralParser` 실행.

### 2.2. 모듈 구조
각 카드사별 로직은 독립된 모듈(파일)로 분리하여 유지보수성을 높인다.
```
lib/loaders/
├── index.ts          # Parser Factory (selectParser)
├── types.ts          # 공통 타입 정의
├── base.ts           # BaseLoader 추상 클래스
├── hyundai.ts        # 현대카드 로더
├── lotte.ts          # 롯데카드 로더
├── samsung.ts        # 삼성카드 로더
├── kb.ts             # KB국민카드 로더
├── onnuri.ts         # 온누리상품권 로더
├── seongnam.ts       # 성남사랑상품권 로더
├── manual.ts         # 직접입력 로더
└── general.ts        # 일반 파서 (Fallback)
```

## 3. 공통 데이터 명세 (Common Output Schema)
모든 로더는 파싱 후 아래 형태의 객체 리스트를 반환해야 한다.

```typescript
interface ParsedTransaction {
  date: string;           // 'YYYY-MM-DD'
  merchant: string;       // 가맹점명
  amount: number;         // 정수형 (원 단위)
  category: string;       // '미분류' | '기존할부'
  sourceType: string;     // '현대카드' | '롯데카드' 등
  isInstallment: boolean; // 할부 여부
  rawData: unknown;       // 디버깅용 원본 데이터
}
```

## 4. 카드사별 상세 로직 (Specific Logic)

### 4.1. 현대카드 (Hyundai Card) ⚠️ 중요 업데이트

#### 식별 키워드
* "결제원금", "이용가맹점", "할부/회차"

#### 컬럼 인덱스 (헤더 기준)
| Index | 컬럼명 | 설명 |
|-------|--------|------|
| 0 | 이용일 | 날짜 |
| 1 | 이용카드 | 카드 종류 |
| 2 | 이용가맹점 | 가맹점명 (금액이 포함될 수 있음) |
| 3 | 이용금액 | 비어있는 경우 많음 |
| 4 | 할부/회차 | 할부 정보 |
| 5 | 적립/할인율(%) | - |
| 6 | 예상적립/할인 | **실제 결제금액** (이번 달) |
| 7 | 결제원금 | 소계/합계 행 또는 할부 전체 금액 |
| 8 | 결제후잔액 | 항상 0 |
| 9 | 수수료(이자) | 항상 0 또는 빈 문자열 |

#### 금액 추출 우선순위 (중요)
실제 분석 결과, 현대카드 파일의 금액 추출은 다음 순서를 따라야 함:

1. **인덱스 6 (예상적립/할인):** 이번 달 실제 결제할 금액
   * 할부의 경우 인덱스 7은 전체 금액이고, 인덱스 6이 이번 달 할부금
2. **인덱스 7 (결제원금):** 소계/합계 행에서 사용
3. **뒤에서부터 찾기:** 컬럼 개수가 다를 경우 대비
   * 검색 범위: 인덱스 4 이상만 (가맹점명 컬럼 제외)
4. **가맹점명에서 추출:** 최후 수단 (예: "커피빈코리아12,000" → 12000)

#### 스킵 키워드 (Skip Keywords)
다음 키워드가 포함된 행은 거래 내역에서 제외:
* 소비쿠폰, 청구할인, 상품권사용, 민생회복, 할인, 소계, 합계, 포인트

#### '기존할부' 분류 로직
* "할부/회차" 컬럼 값에 `/` (슬래시)가 포함된 분수 형태(예: `9/7`)가 있는 경우
* `category` = '기존할부'

#### 데이터 검증 (Validation)
1. "총 합계" 행을 파일 하단에서 찾음 (뒤에서 15행 이내)
2. 총 합계 행의 인덱스 7 값이 파일 합계
3. 모든 데이터 행의 인덱스 6 합계가 파일 합계와 일치해야 함
4. 불일치 시 에러 팝업 표시:
   * 파일명, 파일 합계, 로딩 합계 표시
   * DB 저장 차단

#### 전처리 (Cleanup)
* 검증 완료 후, `amount`가 0 이하인 행은 제거

### 4.2. 롯데카드 (Lotte Card)

#### 식별 키워드
* "이용가맹점", "수수료", "원금" (복수 존재)

#### 매핑 규칙
* **시트:** 데이터가 있는 시트 자동 감지 (Sheet1 외 다른 시트도 검사)
* **날짜:** "이용일" 컬럼
* **이용처:** "이용가맹점" 컬럼
* **금액:** "원금" 컬럼 (일시불) 또는 "원금" + "수수료" (할부)

#### '기존할부' 분류 로직
* "할부" 컬럼에 숫자가 존재하는 경우(빈칸이 아님)
* `amount` = "원금" + "수수료" (두 컬럼의 합)

#### 데이터 검증
* 파싱한 `amount` 총합 == "합계" 행의 금액

### 4.3. 삼성카드 (Samsung Card)

#### 식별 키워드
* "가맹점", "일시불합계"

#### 매핑 규칙
* **날짜:** "이용일" 컬럼
* **이용처:** "가맹점" 컬럼
* **금액:** "원금" 컬럼

#### '기존할부' 분류 로직
* "회차" 컬럼에 숫자가 존재하는 경우

#### 데이터 검증
* 파싱한 `amount` 총합 == "일시불합계" 행의 숫자

### 4.4. KB국민카드 (KB Card)

#### 식별 키워드
* "이용하신 가맹점", "회차", "원금"

#### 매핑 규칙
* **날짜:** "이용일자" 컬럼
* **이용처:** "이용하신 가맹점" 컬럼
* **금액:** "원금" 컬럼
  * 주의: "원금" 컬럼이 2개 존재할 수 있음
  * "회차" 컬럼 바로 다음에 나오는 "원금" 컬럼 사용

#### '기존할부' 분류 로직
* "회차" 컬럼에 숫자가 존재하는 경우

#### 데이터 검증
* 파싱한 `amount` 총합 == "일시불합계" 행의 숫자

### 4.5. 온누리상품권 (Onnuri Gift Card)

#### 식별 키워드
* "거래일자", "가맹점 및 상품권명", "거래금액"

#### 컬럼 인덱스 (헤더 기준)
| Index | 컬럼명 | 설명 |
|-------|--------|------|
| 0 | 거래일자 | 날짜 (YYYYMMDD) |
| 1 | 거래시각 | 시간 (HHMMSS) |
| 2 | 거래구분 | "결제" |
| 3 | 가맹점 및 상품권명 | 가맹점명 |
| 4 | 사업자번호 | - |
| 5 | 거래방식 | "QR결제", "카드결제", "온라인몰" |
| 6 | 거래유형 | "단일결제", "복합결제" |
| 7 | 거래상태 | "결제완료" |
| 8 | 거래금액 | 결제 금액 |

#### 매핑 규칙
* **날짜:** "거래일자" 컬럼 (YYYYMMDD → YYYY-MM-DD 변환)
* **이용처:** "가맹점 및 상품권명" 컬럼
* **금액:** "거래금액" 컬럼

#### 특이사항
* 상품권이므로 할부 거래 없음 (`is_installment` 항상 `false`)
* "거래상태"가 "결제완료"인 건만 처리
* 합계 검증 로직 없음 (개별 거래만 존재)

#### 파일명 인식
* 파일명에 "온누리" 또는 "onnuri" 포함 시 인식
* 헤더 키워드로도 자동 인식

### 4.6. 성남사랑상품권 (Seongnam Sarang Gift Card) 🔐

#### 식별 키워드
* "거래일시", "사용처", "거래금액"

#### 파일명 인식
* 파일명에 "chak" (성남사랑상품권 앱 이름) 포함 시 인식
* 파일명에 "성남사랑" 또는 "seongnam" 포함 시 인식
* 헤더 키워드로도 자동 인식

#### 컬럼 인덱스 (헤더 기준)
| Index | 컬럼명 | 설명 |
|-------|--------|------|
| 0 | 순번 | 행 번호 (숫자) |
| 1 | 상품권명 | "성남사랑상품권" |
| 2 | 거래일시 | 날짜+시간 (YYYY-MM-DD HH:MM:SS) |
| 3 | 거래구분 | "결제완료" |
| 4 | 거래방법 | "가맹점 STAND QR" 등 |
| 5 | 사용처 | 가맹점명 |
| 6 | 거래금액 | 결제 금액 (쉼표 포함) |
| 7 | 잔고 | 잔액 |

#### 매핑 규칙
* **날짜:** "거래일시" 컬럼 (YYYY-MM-DD HH:MM:SS → YYYY-MM-DD 변환)
* **이용처:** "사용처" 컬럼
* **금액:** "거래금액" 컬럼 (쉼표 제거 후 숫자 변환)

#### 특이사항
* **비밀번호 보호:** 파일이 기본적으로 암호화되어 있음
  * 비밀번호: 사용자의 생년월일 8자리 (예: 19840222)
  * 업로드 시 비밀번호 입력 다이얼로그 표시
  * 힌트: "생년월일 8자리"
* 상품권이므로 할부 거래 없음 (`is_installment` 항상 `false`)
* "거래구분"이 "결제완료"인 건만 처리
* 순번이 숫자가 아닌 행(합계 등)은 스킵
* 헤더 앞에 메타 정보(회원명, 조회기간 등)가 있음
* 헤더가 두 줄로 구성됨 (메인 헤더 + 서브헤더)

#### 파일 구조
```
Row 1: 지역상품권 거래내역
Row 3: 회원명, 조회기간
Row 4: 휴대폰번호, 요청일시
Row 6: 안내 메시지
Row 8: 헤더 (순번, 상품권명, 거래일시, ...)
Row 9: 서브헤더 (현금영수증 관련)
Row 10+: 데이터
```

### 4.7. 일반 파서 (General Parser - Fallback)

#### 대상
* 위 로직에 해당하지 않는 파일

#### 로직
* 정규식을 사용하여 날짜(`YYYY-MM-DD` 등), 금액(숫자), 텍스트(가맹점) 패턴 추출
* 별도의 합계 검증 로직은 수행하지 않음
* "검증되지 않음" 상태로 사용자에게 확인 요청

## 5. 예외 처리 (Exception Handling)

| 상황 | 처리 방법 |
|------|----------|
| 파싱 실패 | "지원하지 않는 형식이거나 파일이 변경되었습니다" 오류 표시 |
| 검증 실패 | "파일 내 합계({A})와 로딩된 합계({B})가 다릅니다" 팝업 표시, DB 저장 차단 |
| 시트 없음 | 모든 시트 검사 후 헤더 없으면 파싱 실패 |
| 중복 데이터 | 날짜+가맹점+금액 기준 중복 감지, 중복 건수 표시 |

## 6. 테스트 현황

| 로더 | 테스트 수 | 상태 |
|------|----------|------|
| 현대카드 | 16개 | ✅ 통과 |
| 삼성카드 | 7개 | ✅ 통과 |
| 롯데카드 | 7개 | ✅ 통과 |
| KB국민카드 | 8개 | ✅ 통과 |
| 온누리상품권 | 11개 | ✅ 통과 |
| 성남사랑상품권 | 15개 | ✅ 통과 |
| 유틸리티 | 10개 | ✅ 통과 |
| 차트 버그 | 4개 | ✅ 통과 |
| **총계** | **78개** | **✅ 전체 통과** |

## 7. 최근 업데이트 (2025-12-30)

### 암호화 파일 지원
- **ZIP 방식:** 성남사랑상품권 기본 암호화 (xlsx-populate)
- **OLE2 방식:** 일부 레거시 암호화 (officecrypto-tool)
- **비밀번호 재사용:** 같은 패턴 파일에 자동 적용
- **건너뛰기:** 비밀번호 모를 경우 해당 파일만 스킵

### 파서 선택 개선
- 모든 시트 검사 후 헤더 자동 탐지
- 파일명 기반 힌트 + 헤더 검증 조합

---

*문서 업데이트: 2025-12-30*
*실제 구현 코드: `src/lib/loaders/`*
